<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">


<mapper namespace="com.ustb.softverify.mapper.SoftInfoDAO">

    <insert id="insertSoft" keyProperty="sid" useGeneratedKeys="true">
        insert into t_soft (soft_name,soft_desc,soft_path,doc_path,hash,status,uid) values (#{softName},#{softDesc},#{softPath},#{docPath},#{hash},#{status},#{user.uid})
    </insert>


    <resultMap id="softInfoResult" type="com.ustb.softverify.entity.po.SoftInfo">
        <id property="sid" column="sid"/>
        <result property="softName" column="softname"/>
        <result property="softDesc" column="softdesc"/>
        <result property="status" column="status"/>
        <association property="user" javaType="com.ustb.softverify.entity.po.User">
            <id property="uid" column="uid"/>
            <result property="uname" column="uname"/>
            <result property="company" column="ucompany"/>
            <result property="phone" column="uphone"/>
            <result property="govUserId" column="ugovuserid"/>
        </association>
    </resultMap>

    <select id="findByPager" resultMap="softInfoResult" >
        SELECT
            s.sid sid, s.soft_name softname, s.soft_desc softdesc, s.status status,
            u.uid uid, u.uname uname, u.company ucompany, u.phone uphone, u.gov_user_id ugovuserid
        FROM
            t_soft s
        LEFT JOIN
            t_user u
        ON
            s.uid = u.uid
        WHERE
            s.status IN
        <foreach item="item" collection="status" separator="," open="(" close=")" index="">
          #{item, jdbcType=INTEGER}
        </foreach>
        LIMIT
            #{page},#{size}
    </select>

    <select id="countUnVerifiedSoft" resultType="long">
        SELECT COUNT(1) FROM t_soft WHERE status IN
        <foreach item="item" collection="status" separator="," open="(" close=")" index="">
          #{item, jdbcType=INTEGER}
        </foreach>
    </select>

    <select id="getSoftPath" resultType="string">
        select
            s.soft_path
        from
            t_soft s
        LEFT JOIN
            t_user u
        ON
            s.uid = u.uid
        WHERE
            u.uid = (SELECT uid FROM t_user WHERE gov_user_id = #{govUserId})
        AND
            s.soft_name = #{softName};
    </select>

    <update id="updateSoftStatusToSuccess" >
        UPDATE
            t_soft
        SET
            t_soft.`status` = #{status}
        WHERE
            t_soft.sid = (
                SELECT
                    tmp.id
                FROM
                    (SELECT
                                t_soft.sid id
                        FROM
                                t_soft
                        LEFT JOIN
                                t_user
                        ON
                                t_soft.uid = t_user.uid
                        WHERE
                                t_user.uid = (SELECT uid FROM t_user WHERE gov_user_id = #{govUserId})
                        AND
                                t_soft.soft_name = #{softName}
                    ) as tmp
            );
    </update>

    <update id="updateSoftStatusToFail" >
        UPDATE
            t_soft
        SET
            t_soft.`status` = #{status}, t_soft.soft_path = null, t_soft.doc_path = null, t_soft.hash = null
        WHERE
            t_soft.sid = (
                SELECT
                    tmp.id
                FROM
                    (SELECT
                                t_soft.sid id
                        FROM
                                t_soft
                        LEFT JOIN
                                t_user
                        ON
                                t_soft.uid = t_user.uid
                        WHERE
                                t_user.uid = (SELECT uid FROM t_user WHERE gov_user_id = #{govUserId})
                        AND
                                t_soft.soft_name = #{softName}
                    ) as tmp
            );
    </update>

    <resultMap id="pathMap" type="java.util.HashMap" >
        <result property="softPath" column="softpath"/>
        <result property="docPath" column="docpath"/>
    </resultMap>

    <select id="getSoftPathAndDocPath" resultMap="pathMap">
        SELECT
            s.soft_path softpath, s.doc_path docpath
        FROM
            t_soft s
        LEFT JOIN
            t_user u
        ON
            s.uid = u.uid
        WHERE
            u.uid = (SELECT uid FROM t_user WHERE gov_user_id = #{govUserId})
        AND
            s.soft_name = #{softName};
    </select>

    <select id="findByPagerSuccess" resultMap="softInfoResult" >
        SELECT
            s.sid sid, s.soft_name softname, s.soft_desc softdesc, s.status status,
            u.uid uid, u.uname uname, u.company ucompany, u.phone uphone, u.gov_user_id ugovuserid
        FROM
            t_soft s
        LEFT JOIN
            t_user u
        ON
            s.uid = u.uid
        WHERE
            s.status = #{status}
        LIMIT
            #{page},#{size}
    </select>

    <select id="countVerifySuccess" resultType="long">
        SELECT COUNT(1) FROM t_soft WHERE status = #{status};
    </select>

    <select id="findByPagerFail" resultMap="softInfoResult" >
        SELECT
            s.sid sid, s.soft_name softname, s.soft_desc softdesc, s.status status,
            u.uid uid, u.uname uname, u.company ucompany, u.phone uphone, u.gov_user_id ugovuserid
        FROM
            t_soft s
        LEFT JOIN
            t_user u
        ON
            s.uid = u.uid
        WHERE
            s.status = #{status}
        LIMIT
            #{page},#{size}
    </select>

    <select id="countVerifyFail" resultType="long">
        SELECT COUNT(1) FROM t_soft WHERE status = #{status};
    </select>


    <select id="getSoftByUIdAndName" resultType="SoftInfo">
        select * from t_soft where uid = #{uid} and soft_name = #{softName}
    </select>

</mapper>